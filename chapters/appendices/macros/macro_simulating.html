
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Simulating image formation &#8212; Introduction to Bioimage Analysis</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mycss.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="prev" title="Difference of Gaussians" href="macro_dog.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script defer data-domain="bioimagebook.github.io" src="https://plausible.io/js/plausible.js"></script>
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/book-logo-smaller.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Introduction to Bioimage Analysis</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../README.html">
                    Introduction to Bioimage Analysis
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Front matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/acknowledgements/acknowledgements.html">
   Acknowledgements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/license.html">
   License
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/disclaimer.html">
   Disclaimer
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Before we begin
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/preface/preface.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/reading/reading.html">
   How to read this book
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introducing images
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/1-images_and_pixels/images_and_pixels.html">
   Images &amp; pixels
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/1-images_and_pixels/imagej.html">
     ImageJ: Images &amp; pixels
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/1-images_and_pixels/python.html">
     Python: Images &amp; pixels
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/2-measurements/measurements.html">
   Measurements &amp; histograms
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/2-measurements/imagej.html">
     ImageJ: Measurements &amp; histograms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/2-measurements/python.html">
     Python: Measurements &amp; histograms
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/3-bit_depths/bit_depths.html">
   Types &amp; bit-depths
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/3-bit_depths/imagej.html">
     ImageJ: Types &amp; bit-depths
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/3-bit_depths/python.html">
     Python: Types &amp; bit-depths
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/4-colors/colors.html">
   Channels &amp; colors
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/4-colors/imagej.html">
     ImageJ: Channels &amp; colors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/4-colors/python.html">
     Python: Channels &amp; colors
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/5-pixel_size/pixel_size.html">
   Pixel size &amp; dimensions
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/5-pixel_size/imagej.html">
     ImageJ:  Pixel size &amp; dimensions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/5-pixel_size/python.html">
     Python:  Pixel size &amp; dimensions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/6-files/files.html">
   Files &amp; file formats
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/6-files/imagej.html">
     ImageJ: Files &amp; file formats
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/6-files/python.html">
     Python: Files &amp; file formats
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Processing &amp; analysis
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../2-processing/1-processing_and_analysis/processing_and_analysis.html">
   Image processing &amp; analysis
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../2-processing/2-point_operations/point_operations.html">
   Point operations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../2-processing/2-point_operations/imagej.html">
     ImageJ: Point operations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../2-processing/3-thresholding/thresholding.html">
   Thresholding
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../2-processing/3-thresholding/imagej.html">
     ImageJ: Thresholding
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../2-processing/4-filters/filters.html">
   Filters
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../2-processing/4-filters/imagej.html">
     ImageJ: Filters
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../2-processing/5-morph/morph.html">
   Morphological operations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../2-processing/5-morph/imagej.html">
     ImageJ: Morphological operations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../2-processing/6-transforms/transforms.html">
   Image transforms
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../2-processing/6-transforms/imagej.html">
     ImageJ: Image transforms
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../2-processing/7-multidimensional_processing/multidimensional_processing.html">
   Multidimensional processing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../2-processing/7-multidimensional_processing/imagej.html">
     ImageJ: Multidimensional processing
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Fluorescence microscopy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../3-fluorescence/1-formation_overview/formation_overview.html">
   From photons to pixels
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../3-fluorescence/2-formation_spatial/formation_spatial.html">
   Blur &amp; the PSF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../3-fluorescence/3-formation_noise/formation_noise.html">
   Noise
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../3-fluorescence/4-microscope_types/microscope_types.html">
   Microscopes &amp; detectors
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../next_steps/next_steps.html">
   Beyond this book
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python/python.html">
   Python Primer
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="macro_intro.html">
   ImageJ: Writing macros
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="macro_dog.html">
     Difference of Gaussians
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Simulating image formation
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/bioimagebook/bioimagebook.github.io/main?urlpath=tree/chapters/appendices/macros/macro_simulating.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../_sources/chapters/appendices/macros/macro_simulating.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download notebook file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        <a href="../../../_sources/chapters/appendices/macros/macro_simulating.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#image-formation-summary">
     Image formation summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recording-the-main-steps">
   Recording the main steps
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#making-improvements">
   Making improvements
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#normalizing-the-image">
     Normalizing the image
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#varying-the-fluorescence-emission-rate">
     Varying the fluorescence emission rate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulating-binning">
     Simulating binning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#varying-bit-depths">
     Varying bit-depths
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rounding-to-integer-values">
     Rounding to integer values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#final-code">
     Final code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#uses-limitations">
   Uses &amp; limitations
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Simulating image formation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#image-formation-summary">
     Image formation summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recording-the-main-steps">
   Recording the main steps
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#making-improvements">
   Making improvements
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#normalizing-the-image">
     Normalizing the image
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#varying-the-fluorescence-emission-rate">
     Varying the fluorescence emission rate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulating-binning">
     Simulating binning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#varying-bit-depths">
     Varying bit-depths
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rounding-to-integer-values">
     Rounding to integer values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#final-code">
     Final code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#uses-limitations">
   Uses &amp; limitations
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="simulating-image-formation">
<span id="chap-macro-simulating"></span><h1>Simulating image formation<a class="headerlink" href="#simulating-image-formation" title="Permalink to this headline">#</a></h1>
<div class="cell tag_hide-cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="c1"># Default imports</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../../&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">helpers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">myst_nb</span> <span class="kn">import</span> <span class="n">glue</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
</pre></div>
</div>
</div>
</div>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>The Difference of Gaussians macro developed in <a class="reference internal" href="macro_intro.html#chap-macro-intro"><span class="std std-ref">ImageJ: Writing macros</span></a> was useful, but quite simple.
This section contains an extended practical, the goal of which is to develop a somewhat more sophisticated macro that takes an ‘ideal’ image, and then simulates how it would look after being recorded by a fluorescence microscope.
It can be used not only to get a better understanding of the image formation process, but also to generate test data for analysis algorithms.
By creating simulations with different settings, we can investigate how our results might be affected by changes in image acquisition and quality.</p>
<section id="image-formation-summary">
<h3>Image formation summary<a class="headerlink" href="#image-formation-summary" title="Permalink to this headline">#</a></h3>
<p>The following is a summary of the aspects of image formation discussed in this book:</p>
<ul class="simple">
<li><p>Images are composed of pixels, each of which has a <strong>single numeric value</strong> (not a color!).</p></li>
<li><p>The value of a pixel in fluorescence microscopy relates to a number of detected <strong>photons</strong> – or, more technically, the charge of the electrons produced by the photons striking a detector.</p></li>
<li><p>Images can have many <strong>dimensions</strong>. The number of dimensions is essentially the number of things you need to know to identify each pixel (e.g. time point, channel number, <em>x</em> coordinate, <em>y</em> coordinate, <em>z</em> slice).</p></li>
<li><p>The two main factors that limit image quality are <strong>blur</strong> and <strong>noise</strong>. Both are inevitable, and neither can be completely overcome.</p></li>
<li><p>Blur is characterized by the <strong>point spread function (PSF)</strong> of the microscope, which is the 3D volume that would be the result of imaging a single light-emitting point.
It acts as a <strong>convolution</strong>.</p></li>
<li><p>In the focal plane, the image of a point is an <strong>Airy pattern</strong>. Most of the light is contained within a central region, the <strong>Airy disk</strong>.</p></li>
<li><p>The <strong>spatial resolution</strong> is a measure of the separation that must exist between structures before they can adequately be distinguished as separate, and relates to the size of the PSF (or Airy disk in 2D).</p></li>
<li><p>The two main types of noise are <strong>photon noise</strong> and <strong>read noise</strong>. The former is caused by the randomness of photon emission, while the latter arises from imprecisions in quantifying numbers of detected photons.</p></li>
<li><p><strong>Detecting more photons</strong> helps to overcome the problems caused by <em>both</em> types of noise.</p></li>
<li><p>Different types of microscope have different advantages and costs in terms of <strong>spatial information</strong>, <strong>temporal resolution</strong> and <strong>noise</strong>.</p></li>
<li><p><strong>PMTs</strong> are used to detect photons for single pixels, while <strong>CCDs</strong> and <strong>EMCCDs</strong> are used to detect photons for many pixels in parallel.</p></li>
</ul>
<p>The macro in this chapter will work for 2D images, and simulate the three main components:</p>
<ol class="simple">
<li><p>the blur of the PSF</p></li>
<li><p>photon noise</p></li>
<li><p>read noise</p></li>
</ol>
<p>Furthermore, the macro will ultimately be written in such a way that allows us to investigate the effects of changing some additional parameters:</p>
<ul class="simple">
<li><p>the size of the PSF (related to the objective lens NA and microscope type)</p></li>
<li><p>the amount of fluorescence being emitted from the brightest region</p></li>
<li><p>the amount of background (from stray light and other sources)</p></li>
<li><p>the exposure time (and therefore number of detected photons)</p></li>
<li><p>the detector’s offset</p></li>
<li><p>the detector’s gain</p></li>
<li><p>the detector’s read noise</p></li>
<li><p>camera binning</p></li>
<li><p>bit-depth</p></li>
</ul>
</section>
</section>
<section id="recording-the-main-steps">
<h2>Recording the main steps<a class="headerlink" href="#recording-the-main-steps" title="Permalink to this headline">#</a></h2>
<p>It doesn’t really matter which image you use for this, but I recommend a single-channel 2D image that starts out without any obvious noise (e.g. the <em>Happy cell.tif</em> image).
After starting the macro recorder, complete the following steps to create the main structure for the macro:</p>
<figure class="margin align-default" id="id2">
<img alt="../../../_images/macros_simulated_orig.png" src="../../../_images/macros_simulated_orig.png" />
<figcaption>
<p><span class="caption-number">Fig. 161 </span><span class="caption-text">Example input image</span><a class="headerlink" href="#id2" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<figure class="margin align-default" id="id3">
<img alt="../../../_images/macros_simulated.png" src="../../../_images/macros_simulated.png" />
<figcaption>
<p><span class="caption-number">Fig. 162 </span><span class="caption-text">Example output image</span><a class="headerlink" href="#id3" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<ul class="simple">
<li><p>Ensure the starting image is 32-bit.</p></li>
<li><p>Run <span class="menuselection">Process ‣ Filters ‣ Gaussian Blur…</span> using a sigma value of 2 to simulate the convolution with the PSF.</p></li>
<li><p>Here, we will assume that there are some background photons from other sources, but around the same number at every pixel in the image.
So we can simply add a constant to this image using <span class="menuselection">Add…</span>.
The value should be small, perhaps 10.</p></li>
<li><p>The image now contains the ‘average rates of photon emission’ that we would normally like to have for one particular exposure time (i.e. it is noise-free).
If we change the exposure time, we should change the pixel values similarly so that the rates remain the same.
Because adjusting the exposure works like a multiplication, we can use the <span class="menuselection">Process ‣ Math ‣ Multiply…</span> command. Set it to a ‘default’ value of 1 for now.</p></li>
<li><p>To convert the photon emission rates into actual photon counts that we could potentially detect, we need to simulate photon noise by replacing each pixel by a random value from a Poisson distribution that that has the same <span class="math notranslate nohighlight">\(\lambda\)</span> as the rate itself.
At the time of writing, there’s no built-in command in ImageJ or Fiji to simulate Poisson noise but we can install <em>RandomJ</em> using the instructions at <a class="reference external" href="https://imagescience.org/meijering/software/randomj/">https://imagescience.org/meijering/software/randomj/</a>. Then add noise by calling <span class="menuselection">Plugins ‣ RandomJ ‣ RandomJ Poisson</span>, making sure to set the <span class="guilabel">Insertion:</span> value to <span class="guilabel">Modulatory</span>. The <span class="guilabel">Mean</span> value will be ignored, so its setting does not matter.</p>
<ul>
<li><p>Notice that all the pixels should now have integer values: you cannot detect parts of photons.</p></li>
</ul>
</li>
<li><p>The detector gain scales up the number of electrons produced by detected photons.
Make room for it by including another multiplication, although for now set the value to 1 (i.e.
no extra gain).</p></li>
<li><p>Simulate the detector offset by adding another constant, e.g. 100.</p></li>
<li><p>Add read noise with <span class="menuselection">Process ‣ Noise ‣ Add Specified Noise…</span>, setting the standard deviation to 5.</p></li>
<li><p>Clip any negative values, by running <span class="menuselection">Process ‣ Math ‣ Min…</span> and setting the value to 0.</p></li>
<li><p>Clip any positive values that exceed the bit-depth, by running <span class="menuselection">Process ‣ Math ‣ Max…</span>. To assume an a 8-bit image, set the value to 255.</p></li>
</ul>
<p>Now is a good time to clean up the code by removing any unnecessary lines, adding suitable comments, and bringing any interesting variables up to the top of the macro so that they can be easily modified later (as in <a class="reference internal" href="macro_dog.html#chap-macro-dog"><span class="std std-ref">Difference of Gaussians</span></a>).
We should also duplicate the image to avoid accidentally modifying the original.
The end result should look something like this:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Variables to change</span><span class="w"></span>
<span class="n">psfSigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="n">backgroundPhotons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="n">exposureTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">readStdDev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="n">detectorGain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">detectorOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<span class="n">maxVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span><span class="w"> </span>

<span class="c1">// Duplicate the image, to avoid changing the original</span><span class="w"></span>
<span class="c1">// Including &quot; &quot; means the default name will be used &amp; </span><span class="w"></span>
<span class="c1">// we don&#39;t need to specify any other</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Duplicate...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Retain a reference so we can close the duplicate at the end </span><span class="w"></span>
<span class="c1">// (since RandomJ Poisson creates another new window)</span><span class="w"></span>
<span class="n">idTemp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getImageID</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Ensure image is 32-bit</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;32-bit&quot;</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Simulate PSF blurring</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Gaussian Blur...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sigma=&quot;</span><span class="o">+</span><span class="n">psfSigma</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Add background photons</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Add...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">backgroundPhotons</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Multiply by the exposure time</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Multiply...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">exposureTime</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Simulate photon noise</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;RandomJ Poisson&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mean=1.0 insertion=modulatory&quot;</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Simulate the detector gain</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Multiply...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">detectorGain</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Simulate the detector offset</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Add...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">detectorOffset</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Simulate read noise</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Add Specified Noise...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;standard=&quot;</span><span class="o">+</span><span class="n">readStdDev</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Clip any negative values</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Min...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=0&quot;</span><span class="p">);</span><span class="w"> </span>

<span class="c1">// Clip the maximum values based on the bit-depth </span><span class="w"></span>
<span class="n">un</span><span class="p">(</span><span class="s">&quot;Max...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">maxVal</span><span class="p">);</span><span class="w"> </span>
</pre></div>
</div>
<p>You would have a perfectly respectable macro if you stopped now, but the following section contains some ways in which it may be improved.</p>
</section>
<section id="making-improvements">
<h2>Making improvements<a class="headerlink" href="#making-improvements" title="Permalink to this headline">#</a></h2>
<section id="normalizing-the-image">
<h3>Normalizing the image<a class="headerlink" href="#normalizing-the-image" title="Permalink to this headline">#</a></h3>
<p>The results you get from running the above macro will change depending upon the original range of the image that you use: that is, an image that starts off with high-valued pixels will end up having much less noise.
To compensate for this somewhat, we can first normalize the image so that all pixels fall into the range 0–1.
To do this, we need to determine the current range of pixel values, which can be found out using the macro function:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">getStatistics</span><span class="p">(</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">);</span><span class="w"> </span>
</pre></div>
</div>
<p>After running this, four variables are created giving the <code class="docutils literal notranslate"><span class="pre">mean</span></code>,
<code class="docutils literal notranslate"><span class="pre">minimum</span></code> and <code class="docutils literal notranslate"><span class="pre">maximum</span></code> pixel values in the image, along with the total image <code class="docutils literal notranslate"><span class="pre">area</span></code>.
Normalization is now possible using <span class="menuselection">Subtract</span> and <span class="menuselection">Divide</span> commands, and adjusting their values. In the end this gives us</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">getStatistics</span><span class="p">(</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">);</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Subtract...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">min</span><span class="p">);</span><span class="w"></span>
<span class="n">divisor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">;</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Divide...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">divisor</span><span class="p">);</span><span class="w"> </span>
</pre></div>
</div>
</section>
<section id="varying-the-fluorescence-emission-rate">
<h3>Varying the fluorescence emission rate<a class="headerlink" href="#varying-the-fluorescence-emission-rate" title="Permalink to this headline">#</a></h3>
<p>The new problem we will have after normalization is that there will be a maximum photon emission rate of 1 in the brightest part of the image, which will give us a image dominated completely by noise.
We can change this by multiplying the pixels again, and so define what we want the emission rate to be in the brightest part of the image.
I suggest creating a variable for this, and setting its value to 10.
Then add the following line immediately after normalization:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">run</span><span class="p">(</span><span class="s">&quot;Multiply...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">maxPhotonEmission</span><span class="p">);</span><span class="w"> </span>
</pre></div>
</div>
<p>Modifying this value allows you to change between simulating samples that are fluorescing more or less brightly.
For a less bright sample, you will most likely need to increase the exposure time to get a similar amount of signal – but beware that increasing the exposure time also involves collecting more unhelpful background photons, so is not quite so good as having a sample where the important parts are intrinsically brighter.</p>
</section>
<section id="simulating-binning">
<h3>Simulating binning<a class="headerlink" href="#simulating-binning" title="Permalink to this headline">#</a></h3>
<p>The main idea of <a class="reference internal" href="../../3-fluorescence/4-microscope_types/microscope_types.html#sec-detectors-binning"><span class="std std-ref">binning</span></a> is that the electrons from multiple pixels are added together prior to readout, so that the number of electrons being quantified is bigger relative to the read noise.
For
2×2 binning this involves splitting the image into distinct 2×2 pixel blocks, and creating another image in which the value of each pixel is the sum of the values within the corresponding block.</p>
<p>This could be done using the <span class="menuselection">Image ‣ Transform ‣ Bin</span> command, with a <span class="guilabel">shrink factor</span> of 2 and the <span class="guilabel">Sum</span> bin method.
The macro recorder can again be used to get the main code that is needed.
After some modification, this becomes</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">doBinning</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">   </span><span class="n">run</span><span class="p">(</span><span class="s">&quot;Bin...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x=2 y=2 bin=Sum&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span>
</pre></div>
</div>
<p>By enclosing the line within a <em>code block</em> (limit by the curly brackets) and beginning the block with <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(doBinning)</span></code>, it’s easy to control whether binning is applied or not.
You simply add an extra variable to your list at the start of the macro</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">doBinning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span>
</pre></div>
</div>
<p>to turn binning on, or</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">doBinning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span>
</pre></div>
</div>
<p>to turn it off.
The lines of code that perform the binning should be inserted <em>before</em> the addition of read noise.</p>
</section>
<section id="varying-bit-depths">
<h3>Varying bit-depths<a class="headerlink" href="#varying-bit-depths" title="Permalink to this headline">#</a></h3>
<p>Varying the simulated bit-depths by changing the maximum value allowed in the image takes a little work: you need to know that the maximum value in an 8-bit image is 255, while for a 12-bit image it is 4095 and so on.
It is more intuitive to just change the image bit-depth and have the macro do the calculation for you.
To do this, you can replace the <code class="docutils literal notranslate"><span class="pre">maxVal</span> <span class="pre">=</span> <span class="pre">255;</span></code> variable at the start of the macro with <code class="docutils literal notranslate"><span class="pre">nBits</span> <span class="pre">=</span> <span class="pre">8;</span></code> and then update the later clipping code to become</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">maxVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">nBits</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Max...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">maxVal</span><span class="p">);</span><span class="w"> </span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">pow(2,</span> <span class="pre">nBits)</span></code> is a function that gives you the value of 2<sup>nBits</sup>.
Now it’s easier to explore the difference between 8-bit, 12-bit and 14-bit images (which are the main bit-depths normally associated with microscope detectors, even if the resulting image is stored as 16-bit).</p>
</section>
<section id="rounding-to-integer-values">
<h3>Rounding to integer values<a class="headerlink" href="#rounding-to-integer-values" title="Permalink to this headline">#</a></h3>
<p>The macro has already clipped the image to a specified bit-depth, but it still contains 32-bit data and so potentially has non-integer values that could not be stored in the 8 or 16-bit images a microscope typically provides as output.
Therefore it remains to round the values to the nearest integer.</p>
<p>There are a few ways to do this: we can convert the image using <span class="menuselection">Image ‣ Type ‣</span> commands, though then we need to be careful about whether there will be any scaling applied.
However, we can avoid thinking about this if we just apply the rounding ourselves.
To do it we need to visit each pixel, extract its value, round the value to the nearest whole number, and put it back in the image.
This requires using <strong>loops</strong>.
The code, which should be added at the end of the macro, looks like this:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Get the image dimensions</span><span class="w"></span>
<span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getWidth</span><span class="p">();</span><span class="w"></span>
<span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getHeight</span><span class="p">();</span><span class="w"> </span>

<span class="c1">// Loop through all the rows of pixels</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Loop through all the columns of pixels</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Extract the pixel value at coordinate (x, y)</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"> </span><span class="c1">// Round the pixel value to the nearest integer</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"> </span><span class="c1">// Replace the pixel value in the image</span><span class="w"></span>
<span class="w">    </span><span class="n">setPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span>
</pre></div>
</div>
<p>This creates two variables, <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>, which are used to store the horizontal and vertical coordinates of a pixel.
Each starts off set to 0 (so we begin with the pixel at 0,0, i.e.
in the top left of the image). The code in the middle is run to set the first pixel value, then the variable <code class="docutils literal notranslate"><span class="pre">x</span></code> is incremented to become 1 – because <code class="docutils literal notranslate"><span class="pre">x++</span></code> means <code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">1</span> <span class="pre">to</span> <span class="pre">x</span></code>.
This process is repeated so long as <code class="docutils literal notranslate"><span class="pre">x</span></code> is less than the image width, <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">width</span></code>.
When <code class="docutils literal notranslate"><span class="pre">x</span></code> eventually becomes equal to the width, it means that all pixel values on the first row of the image have been rounded.
Then <code class="docutils literal notranslate"><span class="pre">y</span></code> is incremented and <code class="docutils literal notranslate"><span class="pre">x</span></code> is reset to zero, before the process repeats and the next row is rounded as well.
This continues until <code class="docutils literal notranslate"><span class="pre">y</span></code> is equal to the image height – at which point the processing is complete <a class="footnote-reference brackets" href="#fn-loops" id="id1">1</a>.</p>
</section>
<section id="final-code">
<h3>Final code<a class="headerlink" href="#final-code" title="Permalink to this headline">#</a></h3>
<p>The final code of my version of the macro is given below:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Variables to change</span><span class="w"></span>
<span class="n">psfSigma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="n">backgroundPhotons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="n">exposureTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="n">readStdDev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="n">detectorGain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">detectorOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<span class="n">nBits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>
<span class="n">maxPhotonEmission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="n">doBinning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Duplicate the image, to avoid changing the original</span><span class="w"></span>
<span class="c1">// Including &quot; &quot; means the default name will be used &amp; </span><span class="w"></span>
<span class="c1">// we don&#39;t need to specify any other</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Duplicate...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Retain a reference so we can close the duplicate at the end </span><span class="w"></span>
<span class="c1">// (since RandomJ Poisson creates another new window)</span><span class="w"></span>
<span class="n">idTemp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getImageID</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Ensure image is 32-bit</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;32-bit&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Normalize the image to the range 0-1</span><span class="w"></span>
<span class="n">getStatistics</span><span class="p">(</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">);</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Subtract...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">min</span><span class="p">);</span><span class="w"></span>
<span class="n">divisor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">;</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Divide...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">divisor</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Define the photon emission at the brightest point</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Multiply...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">maxPhotonEmission</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Simulate PSF blurring</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Gaussian Blur...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sigma=&quot;</span><span class="o">+</span><span class="n">psfSigma</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Add background photons</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Add...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">backgroundPhotons</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Multiply by the exposure time</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Multiply...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">exposureTime</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Simulate photon noise</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;RandomJ Poisson&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mean=1.0 insertion=modulatory&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Simulate the detector gain</span><span class="w"></span>
<span class="c1">// (note this should really add Poisson noise too!)</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Multiply...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">detectorGain</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Simulate binning (optional)</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">doBinning</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="n">run</span><span class="p">(</span><span class="s">&quot;Bin...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x=2 y=2 bin=Sum&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Simulate the detector offset</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Add...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">detectorOffset</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Simulate read noise</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Add Specified Noise...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;standard=&quot;</span><span class="o">+</span><span class="n">readStdDev</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Clip any negative values</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Min...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=0&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Clip the maximum values based on the bit-depth</span><span class="w"></span>
<span class="n">maxVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">nBits</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="n">run</span><span class="p">(</span><span class="s">&quot;Max...&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value=&quot;</span><span class="o">+</span><span class="n">maxVal</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Get the image dimensions</span><span class="w"></span>
<span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getWidth</span><span class="p">();</span><span class="w"></span>
<span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getHeight</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Round the pixels to integer values</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">height</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// Loop through all the columns of pixels</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">width</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="c1">// Extract the pixel value at coordinate (x, y)</span><span class="w"></span>
<span class="w">       </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="c1">// Round the pixel value to the nearest integer</span><span class="w"></span>
<span class="w">       </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="c1">// Replace the pixel value in the image</span><span class="w"></span>
<span class="w">       </span><span class="n">setPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Reset the display range (i.e. image contrast)</span><span class="w"></span>
<span class="n">resetMinAndMax</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Close the temporary image</span><span class="w"></span>
<span class="n">selectImage</span><span class="p">(</span><span class="n">idTemp</span><span class="p">);</span><span class="w"></span>
<span class="n">close</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="uses-limitations">
<h2>Uses &amp; limitations<a class="headerlink" href="#uses-limitations" title="Permalink to this headline">#</a></h2>
<p>Of course, the above macro is based on some assumptions and simplifications.
For example, it treats gain as a simple multiplication of the photon counts – but the gain amplification process also involves some randomness, which introduces extra noise.
Because this noise behaves statistically quite like photon noise, the effect can be thought of as decreasing the number of photons that were detected.
Also, we have treated the background as a constant that is the same everywhere in an image.
In practice, the background usually consists primarily of out-of-focus light from other image planes, and so really should change in different parts of the image, particularly in the widefield case.</p>
<p>Nevertheless, quite a lot of factors have been taken into consideration. By exploring different combinations of settings, you can get a feeling for how they affect overall image quality.
For example, you could try:</p>
<ul class="simple">
<li><p>Increasing the background, while keeping the maximum photon emission the same</p></li>
<li><p>Removing the detector offset, or setting it to a negative value</p></li>
<li><p>Comparing the effects of binning for images with low and high photon counts</p></li>
<li><p>Creating multiple images from the same source data, and then averaging them together to see how the noise is changed</p></li>
</ul>
<p>When planning to implement some analysis strategy – particularly if fluorescence intensity measurements are being made – it may also be useful to test its effectiveness using this macro.
To do so, you would need to</p>
<ul class="simple">
<li><p>Somehow create a ‘perfect’, noise and blur-free example image, either manually or by deconvolving a suitably similar sample image</p></li>
<li><p>Apply your algorithm to this perfect image to find out what it detects and what conclusions you could draw</p></li>
<li><p>Apply the exact same algorithm to a version of the image that has passed through the simulator, and see how different your measurements and conclusions would be.</p></li>
</ul>
<p>Ideally, the results should be the same in both cases: this would suggest your analysis method is robust and can handle images with different levels of quality.
It’s more likely that the results are different, however.
In that case, the comparison gives you some idea of how affected by the imaging process your measurements are – and therefore how reliably they relate to the ‘real’ underlying sample.</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="fn-loops"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>If you’re unfamiliar with programming, the syntax of loops may look quite strange.
Reading through some online tutorials for the ImageJ macro language or for-loops in Java should help demystify what is happening here</p>
</dd>
</dl>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "bioimagebook/bioimagebook.github.io",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters/appendices/macros"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="macro_dog.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Difference of Gaussians</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Pete Bankhead<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>